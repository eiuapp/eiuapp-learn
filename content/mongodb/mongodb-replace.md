---
title: "Mongodb Replace"
date: 2018-02-28T17:37:48+08:00
draft: false
tags: ["mongodb"]
categories: ["mongodb"]
subtitle: ""
descriptions: ""
bigimg:
---


## env

jlch

20180228, 江南嘉捷601313 变更为 三六零601360

## step

```
testrs:PRIMARY> db.self_stock.find({"groups._sort":/601313.SH/})
{ "_id" : "oxKP9t4ipFn59N9tmGQjW1IB0d9M", "groups" : [ { "_name" : "default0", "_alias" : "default0", "_sort" : "600696.SH|601313.SH|000023.SZ|002416.SZ|002180.SZ|002715.SZ|300104.SZ|002070.SZ|002455.SZ|399001.SZ|000001.SH|399006.SZ", "_stocks" : [ "002416.SZ", "002180.SZ", "002715.SZ", "300104.SZ", "002070.SZ", "002455.SZ", "399001.SZ", "000001.SH", "399006.SZ", "000023.SZ", "601313.SH", "600696.SH" ] } ] }
{ "_id" : "oxKP9t581mOc9_CslG6-7KzI2958", "groups" : [ { "_name" : "default0", "_alias" : "default0", "_sort" : "000546.SZ|601313.SH|600367.SH|601890.SH|600311.SH|002447.SZ|399001.SZ|000001.SH|399006.SZ", "_stocks" : [ "000546.SZ", "601313.SH", "600367.SH", "601890.SH", "600311.SH", "002447.SZ", "399001.SZ", "000001.SH", "399006.SZ" ] } ] }
{ "_id" : "test@jiaolongchuhai.com", "groups" : [ { "_name" : "default0", "_alias" : "default0", "_sort" : "000001.SZ|300136.SZ|000928.SZ|002008.SZ|002339.SZ|002375.SZ|002529.SZ|002545.SZ|300004.SZ|300024.SZ|300210.SZ|300220.SZ|300221.SZ|300227.SZ|300337.SZ|300521.SZ|600466.SH|600765.SH|601313.SH|000413.SZ|000536.SZ|002189.SZ|002217.SZ|002273.SZ|300256.SZ|300433.SZ|300503.SZ|300508.SZ|600207.SH|600552.SH|600666.SH|000635.SZ|000890.SZ|002149.SZ|002297.SZ|300034.SZ|600206.SH|600618.SH|601137.SH|000401.SZ|000539.SZ|000601.SZ|000767.SZ|000825.SZ|000877.SZ|000912.SZ|000930.SZ|000932.SZ|002006.SZ|002109.SZ|002234.SZ|600010.SH|600011.SH|600022.SH|600027.SH|600096.SH|600160.SH|600282.SH|600310.SH|600348.SH|600396.SH|600423.SH|600438.SH|600449.SH|600509.SH|600569.SH|600578.SH|600585.SH|600636.SH|600720.SH|600795.SH|600808.SH|600810.SH|600863.SH|601005.SH|601857.SH|601991.SH|000001.SH|399001.SZ|399006.SZ|600039.SH|601766.SH|600971.SH|601398.SH", "_stocks" : [ "000001.SH", "399001.SZ", "399006.SZ", "600039.SH", "601766.SH", "600971.SH", "601398.SH", "000928.SZ", "002008.SZ", "002339.SZ", "002375.SZ", "002529.SZ", "002545.SZ", "300004.SZ", "300024.SZ", "300210.SZ", "300220.SZ", "300221.SZ", "300227.SZ", "300337.SZ", "300521.SZ", "600466.SH", "600765.SH", "601313.SH", "000413.SZ", "000536.SZ", "002189.SZ", "002217.SZ", "002273.SZ", "300256.SZ", "300433.SZ", "300503.SZ", "300508.SZ", "600207.SH", "600552.SH", "600666.SH", "000635.SZ", "000890.SZ", "002149.SZ", "002297.SZ", "300034.SZ", "600206.SH", "600618.SH", "601137.SH", "000401.SZ", "000539.SZ", "000601.SZ", "000767.SZ", "000825.SZ", "000877.SZ", "000912.SZ", "000930.SZ", "000932.SZ", "002006.SZ", "002109.SZ", "002234.SZ", "600010.SH", "600011.SH", "600022.SH", "600027.SH", "600096.SH", "600160.SH", "600282.SH", "600310.SH", "600348.SH", "600396.SH", "600423.SH", "600438.SH", "600449.SH", "600509.SH", "600569.SH", "600578.SH", "600585.SH", "600636.SH", "600720.SH", "600795.SH", "600808.SH", "600810.SH", "600863.SH", "601005.SH", "601857.SH", "601991.SH", "300136.SZ", "000001.SZ" ] }, { "_name" : "StockArtifact", "_alias" : "ALIAS", "_sort" : "|000001.SH|399001.SZ|399006.SZ", "_stocks" : [ "000001.SH", "399001.SZ", "399006.SZ" ] } ] }
{ "_id" : "oxKP9t5T4kKMgPsNCVwoOiAzG3ik", "groups" : [ { "_name" : "default0", "_alias" : "default0", "_sort" : "002504.SZ|300162.SZ|300085.SZ|601313.SH|300333.SZ|002441.SZ|300299.SZ|300336.SZ|000001.SH|399001.SZ|399006.SZ", "_stocks" : [ "000001.SH", "399001.SZ", "399006.SZ", "300299.SZ", "300336.SZ", "002504.SZ", "300162.SZ", "300085.SZ", "601313.SH", "300333.SZ", "002441.SZ" ] } ] }
{ "_id" : "oxKP9t-TeB05y04sIRl_c-uHOn_E", "groups" : [ { "_name" : "default0", "_alias" : "default0", "_sort" : "000001.SH|002011.SZ|600874.SH|603969.SH|000877.SZ|002307.SZ|002302.SZ|300141.SZ|300073.SZ|002369.SZ|002610.SZ|000672.SZ|002128.SZ|600362.SH|600497.SH|600531.SH|600740.SH|601313.SH|601699.SH|603009.SH|600985.SH|300058.SZ|300277.SZ|300364.SZ|300550.SZ|600583.SH", "_stocks" : [ "000001.SH", "002011.SZ", "600874.SH", "603969.SH", "000877.SZ", "002307.SZ", "002302.SZ", "300141.SZ", "300073.SZ", "002369.SZ", "002610.SZ", "000672.SZ", "002128.SZ", "600362.SH", "600497.SH", "600531.SH", "600740.SH", "601313.SH", "601699.SH", "603009.SH", "600985.SH", "300058.SZ", "300277.SZ", "300364.SZ", "300550.SZ", "600583.SH", "603117.SH" ] } ] }
{ "_id" : "oxKP9t9zKc8uFxNS1FhBO5YW2x6I", "groups" : [ { "_name" : "default0", "_alias" : "default0", "_sort" : "000001.SH|399001.SZ|399006.SZ|000725.SZ|002129.SZ|002230.SZ|002916.SZ|600025.SH|600383.SH|600516.SH|600519.SH|600606.SH|601313.SH|601318.SH|601933.SH|000858.SZ|002447.SZ", "_stocks" : [ "000001.SH", "399001.SZ", "399006.SZ", "000725.SZ", "002129.SZ", "002230.SZ", "002916.SZ", "600025.SH", "600383.SH", "600516.SH", "600519.SH", "600606.SH", "601313.SH", "601318.SH", "601933.SH", "000858.SZ", "002447.SZ" ] } ] }
{ "_id" : "oxKP9t9uE7aeQ0RzP7h5kLXn_jSE", "groups" : [ { "_name" : "default0", "_alias" : "default0", "_sort" : "399001.SZ|000001.SH|600571.SH|600064.SH|000839.SZ|000725.SZ|601313.SH|000060.SZ|002146.SZ|601012.SH|000830.SZ|000651.SZ|601318.SH|000001.SZ|000825.SZ|601328.SH|300017.SZ|300104.SZ|601600.SH|600028.SH|300059.SZ|601088.SH|601899.SH|601988.SH|300113.SZ|undefined002229.SZ|undefined300434.SZ|undefined300284.SZ", "_stocks" : [ "undefined002229.SZ", "undefined300434.SZ", "undefined300284.SZ", "399001.SZ", "000001.SH", "600571.SH", "600064.SH", "000839.SZ", "000725.SZ", "601313.SH", "000060.SZ", "002146.SZ", "601012.SH", "000830.SZ", "000651.SZ", "601318.SH", "000001.SZ", "000825.SZ", "601328.SH", "300017.SZ", "300104.SZ", "601600.SH", "600028.SH", "300059.SZ", "601088.SH", "601899.SH", "601988.SH", "300113.SZ" ] }, { "_name" : "FundKing", "_alias" : "ALIAS", "_sort" : "160643.SZ|512570.SH|159951.SZ|512560.SH|502014.SH|150051.SZ|150076.SZ", "_stocks" : [ "160643.SZ", "512570.SH", "159951.SZ", "512560.SH", "502014.SH", "150051.SZ", "150076.SZ", "150265.SZ" ] } ] }
{ "_id" : "oxKP9t_NthJF6HOdn5j8cW6LE1mE", "groups" : [ { "_name" : "default0", "_alias" : "default0", "_sort" : "|000001.SH|399001.SZ|399006.SZ|002430.SZ|002407.SZ|002106.SZ|002256.SZ|002607.SZ|300611.SZ|600559.SH|601313.SH|002886.SZ|300666.SZ|300176.SZ|300085.SZ", "_stocks" : [ "000001.SH", "399001.SZ", "399006.SZ", "002430.SZ", "002407.SZ", "002106.SZ", "002256.SZ", "002607.SZ", "300611.SZ", "600559.SH", "601313.SH", "002886.SZ", "300666.SZ", "300176.SZ", "300085.SZ", "600903.SH" ] } ] }
{ "_id" : "837800504@qq.com", "groups" : [ { "_name" : "default0", "_alias" : "default0", "_sort" : "603818.SH|300104.SZ|000001.SH|300111.SZ|300088.SZ|601288.SH|002687.SZ|601313.SH|300335.SZ|399001.SZ|399006.SZ", "_stocks" : [ "000001.SH", "399001.SZ", "399006.SZ", "002687.SZ", "601313.SH", "601288.SH", "300111.SZ", "300088.SZ", "300335.SZ", "300104.SZ", "603818.SH" ] } ] }
{ "_id" : "oxKP9t1vm0k6FgFMWRHBC-zxza24", "groups" : [ { "_name" : "default0", "_alias" : "default0", "_sort" : "601313.SH|603286.SH|000001.SH|399001.SZ|399006.SZ", "_stocks" : [ "000001.SH", "399001.SZ", "399006.SZ", "603286.SH", "601313.SH" ] } ] }
{ "_id" : "1340765542@qq.com", "groups" : [ { "_name" : "default0", "_alias" : "default0", "_sort" : "000001.SH|399001.SZ|399006.SZ|000736.SZ|603676.SH|600362.SH|600497.SH|600531.SH|600740.SH|300364.SZ|300370.SZ|603009.SH|603117.SH|002128.SZ|000672.SZ|600985.SH|300058.SZ|601313.SH|601899.SH|603993.SH|000513.SZ|000725.SZ|000830.SZ", "_stocks" : [ "000001.SH", "399001.SZ", "399006.SZ", "000736.SZ", "603676.SH", "600362.SH", "600497.SH", "600531.SH", "600740.SH", "300364.SZ", "300370.SZ", "603009.SH", "603117.SH", "002128.SZ", "000672.SZ", "600985.SH", "300058.SZ", "601313.SH", "601899.SH", "603993.SH", "000513.SZ", "000725.SZ", "000830.SZ" ] } ] }
{ "_id" : "dea967838@163.com", "groups" : [ { "_name" : "default0", "_alias" : "default0", "_sort" : "002685.SZ|603716.SH|002230.SZ|000752.SZ|601678.SH|600231.SH|600160.SH|603505.SH|002355.SZ|002688.SZ|000060.SZ|000983.SZ|002519.SZ|600602.SH|000301.SZ|002336.SZ|603466.SH|002237.SZ|002302.SZ|600351.SH|600359.SH|000552.SZ|600997.SH|002229.SZ|000528.SZ|000816.SZ|002080.SZ|600398.SH|600506.SH|600581.SH|600789.SH|600740.SH|601313.SH|300668.SZ|300553.SZ|300212.SZ|000681.SZ|002050.SZ|000048.SZ|002803.SZ|002383.SZ|000893.SZ|300401.SZ|600853.SH|600436.SH|002853.SZ|002856.SZ|000001.SH|399001.SZ|399006.SZ", "_stocks" : [ "000001.SH", "399001.SZ", "399006.SZ", "002853.SZ", "002856.SZ", "000552.SZ", "000816.SZ", "002080.SZ", "002229.SZ", "002302.SZ", "600359.SH", "600398.SH", "600506.SH", "600581.SH", "600789.SH", "600997.SH", "600740.SH", "601313.SH", "300668.SZ", "300553.SZ", "002519.SZ", "600602.SH", "000301.SZ", "300212.SZ", "000528.SZ", "002336.SZ", "603466.SH", "002237.SZ", "000681.SZ", "600351.SH", "002050.SZ", "000048.SZ", "002803.SZ", "002383.SZ", "000893.SZ", "300401.SZ", "600853.SH", "600436.SH", "000060.SZ", "000983.SZ", "002688.SZ", "002230.SZ", "000752.SZ", "601678.SH", "600231.SH", "600160.SH", "603505.SH", "002355.SZ", "002685.SZ", "603716.SH" ] } ] }
testrs:PRIMARY>
```

查找

```
db.test.find({"groups._stocks":/603286.SH/})
```

#### 针对,数组(这里是groups.0._stocks)的处理

* 方法1, 先删除,后插入

```
testrs:PRIMARY> db.test.update({"_id" : "oxKP9t_NthJF6HOdn5j8cW6LE1mE"}, {$pull: {"groups.0._stocks":"601313.SH"}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
testrs:PRIMARY> db.test.find({"_id" : "oxKP9t_NthJF6HOdn5j8cW6LE1mE"})
{ "_id" : "oxKP9t_NthJF6HOdn5j8cW6LE1mE", "groups" : [ { "_name" : "default0", "_alias" : "default0", "_sort" : "|000001.SH|399001.SZ|399006.SZ|002430.SZ|002407.SZ|002106.SZ|002256.SZ|002607.SZ|300611.SZ|600559.SH|601313.SH|002886.SZ|300666.SZ|300176.SZ|300085.SZ", "_stocks" : [ "000001.SH", "399001.SZ", "399006.SZ", "002430.SZ", "002407.SZ", "002106.SZ", "002256.SZ", "002607.SZ", "300611.SZ", "600559.SH", "002886.SZ", "300666.SZ", "300176.SZ", "300085.SZ", "600903.SH" ] } ] }
testrs:PRIMARY> db.test.update({"_id" : "oxKP9t_NthJF6HOdn5j8cW6LE1mE"}, {$push: {"groups.0._stocks":"601360.SH"}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
testrs:PRIMARY> db.test.find({"_id" : "oxKP9t_NthJF6HOdn5j8cW6LE1mE"})
{ "_id" : "oxKP9t_NthJF6HOdn5j8cW6LE1mE", "groups" : [ { "_name" : "default0", "_alias" : "default0", "_sort" : "|000001.SH|399001.SZ|399006.SZ|002430.SZ|002407.SZ|002106.SZ|002256.SZ|002607.SZ|300611.SZ|600559.SH|601313.SH|002886.SZ|300666.SZ|300176.SZ|300085.SZ", "_stocks" : [ "000001.SH", "399001.SZ", "399006.SZ", "002430.SZ", "002407.SZ", "002106.SZ", "002256.SZ", "002607.SZ", "300611.SZ", "600559.SH", "002886.SZ", "300666.SZ", "300176.SZ", "300085.SZ", "600903.SH", "601360.SH" ] } ] }
testrs:PRIMARY> db.test.find({"_id" : "oxKP9t_NthJF6HOdn5j8cW6LE1mE"})
```


#### 针对,字符串(这里是groups.0._sort)的处理

这个因为有点复杂, 所以参考 git仓库 https://gitee.com/tomt/tom_mongodb_update



## ref

- [Mongodb 内嵌数组操作](http://blog.csdn.net/u010807583/article/details/49926291)
- [MongoDB删除数组元素](http://howsun.blog.sohu.com/305176472.html)
- [mongodb update 字符 操作](http://blog.51yip.com/nosql/1638.html)